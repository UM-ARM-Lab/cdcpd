#ifndef VISUALIZATION_TOOLS_H
#define VISUALIZATION_TOOLS_H

#include <thread>
#include <mutex>
#include <atomic>

#include <ros/ros.h>
#include <visualization_msgs/MarkerArray.h>
#include <deformable_manipulation_experiment_params/ros_params.hpp>
#include <arc_utilities/eigen_typedefs.hpp>

namespace smmap
{
    class Visualizer
    {
        // TODO: Move these elsewhere, potentially to a location that is then used by smmap/trajectory.hpp
        typedef Eigen::Matrix3Xd ObjectPointSet;

        public:
            static void InitializeStandardColors();
            static std_msgs::ColorRGBA Red(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Green(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Blue(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Black(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Magenta(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Yellow(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Cyan(const float alpha = 1.0f);
            static std_msgs::ColorRGBA White(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Silver(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Coral(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Olive(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Orange(const float alpha = 1.0f);
            static std_msgs::ColorRGBA Seafoam(const float alpha = 1.0f);

            static constexpr auto ROPE_POINTS_SCALE = 0.005;
            static constexpr auto CLOTH_POINTS_SCALE = 0.005;
            static constexpr auto GRIPPER_X_SCALE = 0.03;
            static constexpr auto GRIPPER_Y_SCALE = 0.03;
            static constexpr auto GRIPPER_Z_SCALE = 0.01;
            static constexpr auto OBJECT_DELTA_SCALE = 0.001;
            static constexpr auto TRANSLATION_SCALE = 0.01;

            // Used to return the ids of markers generated. Useful in cases where
            // multiple markers are generated by a single function call
            typedef std::pair<std::string, int32_t> NamespaceId;
            typedef std::shared_ptr<Visualizer> Ptr;

            Visualizer(
                    std::shared_ptr<ros::NodeHandle> nh,
                    std::shared_ptr<ros::NodeHandle> ph,
                    const bool publish_async = false);

            ~Visualizer();

            bool visualizationsEnabled() const { return !disable_all_visualizations_; }

            void publish(const visualization_msgs::Marker& marker) const;

            void publish(const visualization_msgs::MarkerArray& marker_array) const;

            void purgeAndPublishDeleteAllAction() const;

            void forcePublishNow(const double last_delay = 0.01) const;

            void clearVisualizationsBullet();

            void purgeMarkerList() const;

            // Converts all markers in the async publishing list to "delete" actions
            void deleteAll() const;

            // Publishes a marker with the given name and id with the delete flag set
            void deleteObject(
                    const std::string& marker_name,
                    const int32_t id = 1) const;

            // Publishes markers in namespace marker_name, with ids in the half
            // closed ranged [start_id, end_id) with the delete flag set
            void deleteObjects(
                    const std::string& marker_name,
                    const int32_t start_id = 0,
                    const int32_t end_id = 1024) const;

            std::vector<NamespaceId> visualizePoint(
                    const std::string& marker_name,
                    const Eigen::Vector3d& point,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1,
                    const double scale = 0.005) const;

            std::vector<NamespaceId> visualizePoints(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1,
                    const double scale = 0.005) const;

            std::vector<NamespaceId> visualizePoints(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t id = 1,
                    const double scale = 0.005) const;

            std::vector<NamespaceId> visualizePoints(
                    const std::string& marker_name,
                    const ObjectPointSet& points,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1,
                    const double scale = 0.005) const;

            std::vector<NamespaceId> visualizePoints(
                    const std::string& marker_name,
                    const ObjectPointSet& points,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t id = 1,
                    const double scale = 0.005) const;

            std::vector<NamespaceId> visualizeCubes(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const Eigen::Vector3d& scale,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeCubes(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const Eigen::Vector3d& scale,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeSpheres(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id,
                    const double radius) const;

            std::vector<NamespaceId> visualizeSpheres(const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const std_msgs::ColorRGBA& color,
                    const int32_t starting_id,
                    const std::vector<double>& radiuses) const;

            std::vector<NamespaceId> visualizeSpheres(const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t starting_id,
                    const std::vector<double>& radiuses) const;

            std::vector<NamespaceId> visualizeCapsuleRope(
                    const std::string& marker_name,
                    const EigenHelpers::VectorIsometry3d& rope_node_transforms,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeCapsuleRope(
                    const std::string& marker_name,
                    const EigenHelpers::VectorIsometry3d& rope_node_transforms,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeRope(
                    const std::string& marker_name,
                    const ObjectPointSet& rope,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeRope(
                    const std::string& marker_name,
                    const ObjectPointSet& rope,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeCloth(
                    const std::string& marker_name,
                    const ObjectPointSet& cloth,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeCloth(
                    const std::string& marker_name,
                    const ObjectPointSet& cloth,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeGripper(
                    const std::string& marker_name,
                    const Eigen::Isometry3d& eigen_pose,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeGrippers(
                    const std::string& marker_name,
                    const EigenHelpers::VectorIsometry3d eigen_poses,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeGrippers(
                    const std::string& marker_name,
                    const std::pair<Eigen::Vector3d, Eigen::Vector3d> eigen_positions,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeObjectDelta(
                    const std::string& marker_name,
                    const ObjectPointSet& current,
                    const ObjectPointSet& desired,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 2) const;

            std::vector<NamespaceId> visualizeTranslation(
                    const std::string& marker_name,
                    const geometry_msgs::Point& start,
                    const geometry_msgs::Point& end,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 3) const;

            std::vector<NamespaceId> visualizeTranslation(
                    const std::string& marker_name,
                    const Eigen::Vector3d& start,
                    const Eigen::Vector3d& end,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 3) const;

            std::vector<NamespaceId> visualizeTranslation(
                    const std::string& marker_name,
                    const Eigen::Isometry3d &start,
                    const Eigen::Isometry3d &end,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 3) const;

            std::vector<NamespaceId> visualizeArrows(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& start,
                    const EigenHelpers::VectorVector3d& end,
                    const std_msgs::ColorRGBA& color,
                    const double scale_x,
                    const double scale_y,
                    const double scale_z = 0.0,
                    const int32_t start_id = 1) const;

            std::vector<NamespaceId> visualizeLines(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& start,
                    const EigenHelpers::VectorVector3d& end,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1,
                    const double scale = 0.001) const;

            std::vector<NamespaceId> visualizeLines(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& start,
                    const EigenHelpers::VectorVector3d& end,
                    const std::vector<std_msgs::ColorRGBA>& colors,
                    const int32_t id = 1,
                    const double scale = 0.001) const;

            std::vector<NamespaceId> visualizeLineStrip(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& point_sequence,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1,
                    const double scale = 0.001) const;

            std::vector<NamespaceId> visualizeLineStrip(
                    const std::string& marker_name,
                    const ObjectPointSet& point_sequence,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1,
                    const double scale = 0.001) const;

            std::vector<NamespaceId> visualizeXYZTrajectory(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& point_sequence,
                    const std_msgs::ColorRGBA& color,
                    const int32_t id = 1) const;

            std::vector<NamespaceId> visualizeAxes(
                    const std::string& marker_name,
                    const Eigen::Isometry3d& axes,
                    const double length,
                    const double thickness,
                    const int32_t id = 1) const;

        private:

            visualization_msgs::Marker createMarker(
                    const std::string& marker_name,
                    const EigenHelpers::VectorVector3d& points,
                    const int32_t id) const;

            visualization_msgs::Marker createMarker(
                    const std::string& marker_name,
                    const ObjectPointSet& points,
                    const int32_t id) const;

            void updateMarkerList(const visualization_msgs::Marker& marker) const;
            void publishAsyncMain();

            const std::shared_ptr<ros::NodeHandle> nh_;
            const std::shared_ptr<ros::NodeHandle> ph_;

            const bool publish_async_;
            std::thread publish_thread_;
            std::atomic<bool> running_async_;
            mutable std::mutex markers_mtx_;
            mutable visualization_msgs::MarkerArray async_markers_;

            const bool disable_all_visualizations_;
            ros::ServiceClient clear_markers_srv_;
            ros::Publisher visualization_marker_pub_;
            ros::Publisher visualization_maker_array_pub_;

            // Data needed to properly create visualizations and markers
            const std::string world_frame_name_;
            const double gripper_apperture_;

            static bool standard_colors_initialized_;
            static std_msgs::ColorRGBA red_;
            static std_msgs::ColorRGBA green_;
            static std_msgs::ColorRGBA blue_;
            static std_msgs::ColorRGBA black_;
            static std_msgs::ColorRGBA magenta_;
            static std_msgs::ColorRGBA yellow_;
            static std_msgs::ColorRGBA cyan_;
            static std_msgs::ColorRGBA white_;
            static std_msgs::ColorRGBA silver_;
            static std_msgs::ColorRGBA coral_;
            static std_msgs::ColorRGBA olive_;
            static std_msgs::ColorRGBA orange_;
            static std_msgs::ColorRGBA seafoam_;
    };
}

#endif // VISUALIZATION_TOOLS_H
